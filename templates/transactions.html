{% extends "base.html" %}

{% block title %}Transaction History{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold mb-2">Transaction History</h1>
        <div class="breadcrumbs text-sm">
            <ul>
                <li><a href="{{ url_for('main.index') }}">Dashboard</a></li>
                <li><a href="{{ url_for('portfolio.portfolio_manager') }}">Portfolio</a></li>
                <li>Transactions</li>
            </ul>
        </div>
    </div>

    <!-- P&L Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <!-- Total Realized P&L -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-sm">Total Realized P&L</h2>
                <p class="text-3xl font-bold {{ 'text-success' if total_realized_pnl >= 0 else 'text-error' }}">
                    ${{ "%.2f"|format(total_realized_pnl) }}
                </p>
                <p class="text-xs opacity-70">From all sell transactions</p>
            </div>
        </div>

        <!-- Unrealized P&L -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-sm">Unrealized P&L</h2>
                <p class="text-3xl font-bold {{ 'text-success' if unrealized_pnl >= 0 else 'text-error' }}">
                    ${{ "%.2f"|format(unrealized_pnl) }}
                </p>
                <p class="text-xs opacity-70">Current holdings</p>
            </div>
        </div>

        <!-- Total P&L -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-sm">Combined P&L</h2>
                {% set combined_pnl = total_realized_pnl + unrealized_pnl %}
                <p class="text-3xl font-bold {{ 'text-success' if combined_pnl >= 0 else 'text-error' }}">
                    ${{ "%.2f"|format(combined_pnl) }}
                </p>
                <p class="text-xs opacity-70">Realized + Unrealized</p>
            </div>
        </div>
    </div>

    <!-- Realized P&L by Asset -->
    {% if pnl_summary['by_symbol'] %}
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">Realized P&L by Asset</h2>
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th class="text-right">Total Realized P&L</th>
                            <th class="text-right">Total Sold Value</th>
                            <th class="text-right">Number of Sells</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for symbol, data in pnl_summary['by_symbol'].items() %}
                        <tr>
                            <td class="font-bold">{{ symbol }}</td>
                            <td class="text-right {{ 'text-success' if data['realized_pnl'] >= 0 else 'text-error' }}">
                                ${{ "%.2f"|format(data['realized_pnl']) }}
                            </td>
                            <td class="text-right">${{ "%.2f"|format(data['sale_proceeds']) }}</td>
                            <td class="text-right">{{ data['transactions'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Transaction History Table -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">All Transactions</h2>
                <a href="{{ url_for('portfolio.portfolio_manager') }}" class="btn btn-sm btn-outline">
                    Back to Portfolio
                </a>
            </div>

            {% if transactions %}
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Symbol</th>
                            <th class="text-right">Quantity</th>
                            <th class="text-right">Price</th>
                            <th class="text-right">Total Value</th>
                            <th class="text-right">Realized P&L</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.transaction_date.strftime('%Y-%m-%d') if transaction.transaction_date else 'N/A' }}</td>
                            <td>
                                {% if transaction.transaction_type == 'BUY' %}
                                    <span class="badge badge-info">BUY</span>
                                {% else %}
                                    <span class="badge badge-warning">SELL</span>
                                {% endif %}
                            </td>
                            <td class="font-bold">{{ transaction.symbol }}</td>
                            <td class="text-right">{{ "%.4f"|format(transaction.quantity) }}</td>
                            <td class="text-right">${{ "%.2f"|format(transaction.price) }}</td>
                            <td class="text-right">${{ "%.2f"|format(transaction.quantity * transaction.price) }}</td>
                            <td class="text-right">
                                {% if transaction.transaction_type == 'SELL' and transaction.realized_pnl %}
                                    <span class="{{ 'text-success' if transaction.realized_pnl >= 0 else 'text-error' }} font-bold">
                                        ${{ "%.2f"|format(transaction.realized_pnl) }}
                                    </span>
                                {% else %}
                                    <span class="opacity-50">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Summary Stats -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">Total Transactions</div>
                        <div class="stat-value text-primary">{{ transactions|length }}</div>
                        <div class="stat-desc">
                            {% set buy_count = transactions|selectattr('transaction_type', 'equalto', 'BUY')|list|length %}
                            {% set sell_count = transactions|selectattr('transaction_type', 'equalto', 'SELL')|list|length %}
                            {{ buy_count }} buys, {{ sell_count }} sells
                        </div>
                    </div>
                </div>

                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">Avg Realized Gain per Sell</div>
                        {% set sell_transactions = transactions|selectattr('transaction_type', 'equalto', 'SELL')|list %}
                        {% if sell_transactions|length > 0 %}
                            {% set avg_pnl = total_realized_pnl / sell_transactions|length %}
                            <div class="stat-value {{ 'text-success' if avg_pnl >= 0 else 'text-error' }}">
                                ${{ "%.2f"|format(avg_pnl) }}
                            </div>
                        {% else %}
                            <div class="stat-value text-base-content">$0.00</div>
                        {% endif %}
                        <div class="stat-desc">Per sell transaction</div>
                    </div>
                </div>
            </div>

            {% else %}
            <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>No transactions yet. <a href="{{ url_for('portfolio.portfolio_manager') }}" class="link">Add assets to your portfolio</a> to get started.</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
